# 카카오 페이 뿌리기 기능 구현하기

## 주요 요구사항

카카오페이 머니 뿌리기 기능 구현하기

* 사용자는 다수의 친구들이 있는 대화방에서 뿌릴 금액과 받아갈 대상의 숫자를 입력하여 뿌리기 요청을 발송
* 대화방에 있는 다른 사용자들은 발송된 메세지를 클릭하여 금액을 무작위로 받아가게 됨

* 뿌리기, 받기, 조회 기능을 수행하는 REST API를 구현하는 것이 과제

## 핵심 문제 해결 전략

### 설계 방향

* 요구사항 작게 쪼개기
* 작게 분해한 요구사항에 대한 테스트 케이스 작성하기
* 분해 된 부분 대체 가능하도록 의존성 낮춰 연결하기
* 동시성, 확장성은 인프라에서 처리하기

### 뿌리기 API

#### 요구사항 분석

1. 요청 인터페이스 제공
	* 뿌리기요청API (뿌릴금액, 뿌릴 인원) -> 고유token

2. 예측 불가능한 3자리 문자열로 구성된 고유 token 생성하기
	* 3자리 문자열
		* 3자리? -> 3byte
		* 문자열의 범위? -> [A-Za-z0-9/?~@!#] 

	* 고유한 값
		* 3자리 문자열로 가능한 고유 값의 수? 
		* 85^3 = 약 600K 밖에 안됨

	* 예측 불가능한
		* 후보 85자리 중 랜덤하게 1개+1개+1개 만들기

	* 나중에 더 나은 알고리즘 알게되면 쉽게 바꿀 수 있나?
		* 자리 수 확대 시
		* 생성 알고리즘 변경 시
		* Token 형식 변경 시

	* 동시성/성능 이슈는?


3. 뿌릴 금액을 인원수에 맞게 분배하여 저장하기
	* 분배방법
		* 일단 균등분배 (나머지 남을 경우, 마지막 사람+)
		* 향후 쉽게 변경할 수 있도록 분배+분배규칙 객체 분리
	* 분배정보 저장
		* 각 인원 수 만큼의 분배 정보 저장
			* 1억, 1억명에게.. 1억개 중복 발생
		* 분배 계산 함수를 지정하는 방법
			* 공간 절약, 계산 상태를 관리해야 할 수 있음


### 받기 API

1. 요청 인터페이스 제공
	* 받기API (뿌리기token) -> 받을금액

2. 뿌리기 건 찾기

3. 받기 실패 조건 검사하기
	* 해당 뿌리기에 대해 이미 받기를 완료 했다면 
	* 해당 뿌리기와 동일한 대화방에 속한 사용자라면
	* 자신이 뿌리기 한 건에 대해 받기 요청을 했다면
	* 해당 뿌리기가 10분이 지났다면

3. 할당되지 않은 분배건 찾기
	* 분배건이 어떻게 저장되어 있는가? (List 일 경우 순차 탐색)
	* 저장 형식이 변경 될 경우, 영향도 최소화 되도록 객체 분리
	
4. 사용자에게 할당 하기
	* 할당 정보는 나중에 조회할 때 사용됨
		* 할당 금액, 받은 사용자 ID, 받은 시각 
	* 할당 정보는 사용자가 재 요청할 때 사용됨


### 조회 API

1. 요청 인터페이스 제공
	* 뿌리기요청API (뿌리기token) -> 뿌리기건 현재상태

2. 뿌리기건 현재 상태
	* 현재상태 정보
		* 뿌린 시각
		* 뿌린 금액
		* 받기 완료된 금액
		* 받기 완료된 정보 ([받은 금액, 받은 사용자 아이디] 리스트)

3. 조회 실패 조건 검사하기
	* 뿌린 사람 자신만 조회 가능
	* 뿌린 건에 대한 조회는 7일 동안만 가능 


### API 명세

#### 뿌리기 API

요청

```
POST /money/divvy
```

응답

```
{
    "key": "ABC"
}
```

#### 받기 API

요청
```
PUT /money/divvy/{token}
```
응답

```
{
    "receiveMoney": 1000
}
```


#### 조회 API

요청
```
GET /money/divvy/{token}/report
```

응답
```
{
    "moneyDivvyCreatedAt": 1604709796537,
    "amountOfMoney": 10000,
    "totalReceivedMoney": 2000,
    "receivedList": [
        {
            "receivedMoney": 1000,
            "userId": "1236"
        },
        {
            "receivedMoney": 1000,
            "userId": "3821"
        }
    ]
}
```


### 실행 방법

```
$ git clone https://github.com/just-follow-through/money-divvy.git
$ ./mvnw spring-boot:run
```
